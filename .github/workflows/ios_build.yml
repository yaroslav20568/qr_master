name: iOS Build app

on:
  workflow_dispatch:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        id: flutter-pub-cache
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Create .env file from secrets
        run: |
          echo "# Environment variables for iOS build" > .env
          echo "# These are loaded from GitHub Secrets" >> .env
          echo "" >> .env

          [ -n "$APPHUD_API_KEY" ] && echo "APPHUD_API_KEY=$APPHUD_API_KEY" >> .env || echo "# APPHUD_API_KEY=not_set" >> .env
          [ -n "$APPHUD_PAYWALL_ID" ] && echo "APPHUD_PAYWALL_ID=$APPHUD_PAYWALL_ID" >> .env || echo "# APPHUD_PAYWALL_ID=not_set" >> .env
          [ -n "$APPHUD_PRODUCT_WEEKLY" ] && echo "APPHUD_PRODUCT_WEEKLY=$APPHUD_PRODUCT_WEEKLY" >> .env || echo "# APPHUD_PRODUCT_WEEKLY=not_set" >> .env
          [ -n "$APPHUD_PRODUCT_MONTHLY" ] && echo "APPHUD_PRODUCT_MONTHLY=$APPHUD_PRODUCT_MONTHLY" >> .env || echo "# APPHUD_PRODUCT_MONTHLY=not_set" >> .env

          [ -n "$APPSFLYER_DEV_KEY" ] && echo "APPSFLYER_DEV_KEY=$APPSFLYER_DEV_KEY" >> .env || echo "# APPSFLYER_DEV_KEY=not_set" >> .env
          [ -n "$APPSFLYER_APP_ID" ] && echo "APPSFLYER_APP_ID=$APPSFLYER_APP_ID" >> .env || echo "# APPSFLYER_APP_ID=not_set" >> .env

          [ -n "$APPMETRICA_API_KEY" ] && echo "APPMETRICA_API_KEY=$APPMETRICA_API_KEY" >> .env || echo "# APPMETRICA_API_KEY=not_set" >> .env

          [ -n "$ADMOB_APP_ID" ] && echo "ADMOB_APP_ID=$ADMOB_APP_ID" >> .env || echo "# ADMOB_APP_ID=not_set" >> .env
          [ -n "$ADMOB_BANNER_AD_UNIT_ID" ] && echo "ADMOB_BANNER_AD_UNIT_ID=$ADMOB_BANNER_AD_UNIT_ID" >> .env || echo "# ADMOB_BANNER_AD_UNIT_ID=not_set" >> .env
          [ -n "$ADMOB_INTERSTITIAL_AD_UNIT_ID" ] && echo "ADMOB_INTERSTITIAL_AD_UNIT_ID=$ADMOB_INTERSTITIAL_AD_UNIT_ID" >> .env || echo "# ADMOB_INTERSTITIAL_AD_UNIT_ID=not_set" >> .env
          [ -n "$ADMOB_REWARDED_AD_UNIT_ID" ] && echo "ADMOB_REWARDED_AD_UNIT_ID=$ADMOB_REWARDED_AD_UNIT_ID" >> .env || echo "# ADMOB_REWARDED_AD_UNIT_ID=not_set" >> .env
          [ -n "$ADMOB_REWARDED_INTERSTITIAL_AD_UNIT_ID" ] && echo "ADMOB_REWARDED_INTERSTITIAL_AD_UNIT_ID=$ADMOB_REWARDED_INTERSTITIAL_AD_UNIT_ID" >> .env || echo "# ADMOB_REWARDED_INTERSTITIAL_AD_UNIT_ID=not_set" >> .env
          [ -n "$ADMOB_NATIVE_AD_UNIT_ID" ] && echo "ADMOB_NATIVE_AD_UNIT_ID=$ADMOB_NATIVE_AD_UNIT_ID" >> .env || echo "# ADMOB_NATIVE_AD_UNIT_ID=not_set" >> .env
          [ -n "$ADMOB_APP_OPEN_AD_UNIT_ID_IOS" ] && echo "ADMOB_APP_OPEN_AD_UNIT_ID_IOS=$ADMOB_APP_OPEN_AD_UNIT_ID_IOS" >> .env || echo "# ADMOB_APP_OPEN_AD_UNIT_ID_IOS=not_set" >> .env

          echo "‚úÖ .env file created"
          VARIABLES_SET=$(grep -c '^[A-Z_]*=' .env || echo 0)
          echo "üìã Environment variables set: $VARIABLES_SET/14"
          if [ "$VARIABLES_SET" -lt 2 ]; then
            echo "‚ö†Ô∏è  Warning: APPSFLYER_DEV_KEY and APPSFLYER_APP_ID are recommended"
          fi
        env:
          APPHUD_API_KEY: ${{ secrets.APPHUD_API_KEY }}
          APPHUD_PAYWALL_ID: ${{ secrets.APPHUD_PAYWALL_ID }}
          APPHUD_PRODUCT_WEEKLY: ${{ secrets.APPHUD_PRODUCT_WEEKLY }}
          APPHUD_PRODUCT_MONTHLY: ${{ secrets.APPHUD_PRODUCT_MONTHLY }}
          APPSFLYER_DEV_KEY: ${{ secrets.APPSFLYER_DEV_KEY }}
          APPSFLYER_APP_ID: ${{ secrets.APPSFLYER_APP_ID }}
          APPMETRICA_API_KEY: ${{ secrets.APPMETRICA_API_KEY }}
          ADMOB_APP_ID: ${{ secrets.ADMOB_APP_ID }}
          ADMOB_BANNER_AD_UNIT_ID: ${{ secrets.ADMOB_BANNER_AD_UNIT_ID }}
          ADMOB_INTERSTITIAL_AD_UNIT_ID: ${{ secrets.ADMOB_INTERSTITIAL_AD_UNIT_ID }}
          ADMOB_REWARDED_AD_UNIT_ID: ${{ secrets.ADMOB_REWARDED_AD_UNIT_ID }}
          ADMOB_REWARDED_INTERSTITIAL_AD_UNIT_ID: ${{ secrets.ADMOB_REWARDED_INTERSTITIAL_AD_UNIT_ID }}
          ADMOB_NATIVE_AD_UNIT_ID: ${{ secrets.ADMOB_NATIVE_AD_UNIT_ID }}
          ADMOB_APP_OPEN_AD_UNIT_ID_IOS: ${{ secrets.ADMOB_APP_OPEN_AD_UNIT_ID_IOS }}

      - name: Create GoogleService-Info.plist from secrets
        run: |
          if [ -n "$GOOGLESERVICE_INFO_PLIST" ]; then
            echo "üìù Creating GoogleService-Info.plist from GitHub Secrets..."
            echo "$GOOGLESERVICE_INFO_PLIST" > ios/Runner/GoogleService-Info.plist
            echo "‚úÖ GoogleService-Info.plist created successfully"
            ls -lh ios/Runner/GoogleService-Info.plist
            
          else
            echo "‚ö†Ô∏è  Warning: GOOGLESERVICE_INFO_PLIST secret is not set"
            echo "‚ö†Ô∏è  Firebase features may not work without this file"
            echo "‚ö†Ô∏è  To fix: Add GOOGLESERVICE_INFO_PLIST secret in GitHub repository settings"
          fi
        env:
          GOOGLESERVICE_INFO_PLIST: ${{ secrets.GOOGLESERVICE_INFO_PLIST }}

      - name: Cache CocoaPods
        uses: actions/cache@v4
        id: cocoapods-cache
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}-${{ hashFiles('ios/Podfile') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Setup CocoaPods
        run: |
          sudo gem install cocoapods
          cd ios

          echo "üìù Verifying Podfile exists and has iOS 16.0 minimum deployment target"

          if [ -f Podfile ]; then
            echo "‚úÖ Podfile found"
            if grep -q "^platform :ios" Podfile; then
              PLATFORM_VERSION=$(grep "^platform :ios" Podfile | sed "s/.*'\(.*\)'.*/\1/")
              echo "üìã Current platform version: $PLATFORM_VERSION"
              if [ "$PLATFORM_VERSION" != "16.0" ]; then
                sed -i '' "s|^platform :ios.*|platform :ios, '16.0'|" Podfile
                echo "‚úÖ Updated platform version to 16.0"
              else
                echo "‚úÖ Platform version already set to 16.0"
              fi
            else
              sed -i '' "1s|^|platform :ios, '16.0'\n|" Podfile
              echo "‚úÖ Added platform version 16.0"
            fi
            
            if ! grep -q "IPHONEOS_DEPLOYMENT_TARGET.*16.0" Podfile; then
              if grep -q "post_install" Podfile; then
                if grep -q "IPHONEOS_DEPLOYMENT_TARGET" Podfile; then
                  sed -i '' "s|IPHONEOS_DEPLOYMENT_TARGET.*|IPHONEOS_DEPLOYMENT_TARGET'] = '16.0'|g" Podfile
                else
                  awk '/target\.build_configurations\.each do \|config\|/ { print; print "      config.build_settings['"'"'IPHONEOS_DEPLOYMENT_TARGET'"'"'] = '"'"'16.0'"'"'"; next }1' Podfile > Podfile.tmp && mv Podfile.tmp Podfile
                fi
              else
                printf '\n\npost_install do |installer|\n  installer.pods_project.targets.each do |target|\n    target.build_configurations.each do |config|\n      config.build_settings['"'"'IPHONEOS_DEPLOYMENT_TARGET'"'"'] = '"'"'16.0'"'"'\n    end\n  end\n  installer.pods_project.build_configurations.each do |config|\n    config.build_settings['"'"'IPHONEOS_DEPLOYMENT_TARGET'"'"'] = '"'"'16.0'"'"'\n  end\nend\n' >> Podfile
              fi
              echo "‚úÖ Added IPHONEOS_DEPLOYMENT_TARGET to post_install"
            else
              echo "‚úÖ IPHONEOS_DEPLOYMENT_TARGET already configured in post_install"
            fi
            if grep -q "post_install" Podfile && ! grep -q "installer.pods_project.build_configurations.each" Podfile; then
              awk '/post_install do \|installer\|/ { print; print "  installer.pods_project.build_configurations.each do |config|"; print "    config.build_settings['"'"'IPHONEOS_DEPLOYMENT_TARGET'"'"'] = '"'"'16.0'"'"'"; print "  end"; next }1' Podfile > Podfile.tmp && mv Podfile.tmp Podfile
              echo "‚úÖ Added project-level IPHONEOS_DEPLOYMENT_TARGET"
            fi
          else
            echo "‚ùå Podfile not found! This will cause build failures."
            echo "‚ö†Ô∏è  Flutter will create a basic Podfile, but it may not have correct settings"
            exit 1
          fi

          echo "üìã Podfile contents:"
          cat Podfile | head -20

          echo "üì¶ Installing CocoaPods dependencies"
          COCOAPODS_CACHE_HIT="${{ steps.cocoapods-cache.outputs.cache-hit }}"
          if [ "$COCOAPODS_CACHE_HIT" != "true" ]; then
            echo "üì• Cache miss - updating CocoaPods repo and installing pods"
            pod install --repo-update
          else
            echo "‚úÖ Cache hit - installing pods without repo update (faster)"
            pod install
          fi
          cd ..

      - name: Cache Flutter build artifacts
        uses: actions/cache@v4
        id: flutter-build-cache
        with:
          path: |
            build/ios
            .dart_tool/flutter_build
            .dart_tool/hooks_runner
          key: ${{ runner.os }}-flutter-build-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('lib/**/*.dart') }}
          restore-keys: |
            ${{ runner.os }}-flutter-build-${{ hashFiles('**/pubspec.lock') }}-
            ${{ runner.os }}-flutter-build-

      - name: Cache iOS Xcode artifacts
        uses: actions/cache@v4
        id: xcode-build-cache
        with:
          path: |
            ios/build
            ios/.symlinks
            ios/Flutter/Flutter.framework
            ios/Flutter/Flutter.podspec
            ios/Flutter/Generated.xcconfig
            ios/Flutter/Debug.xcconfig
            ios/Flutter/Release.xcconfig
            ios/Flutter/ephemeral
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-build-${{ hashFiles('ios/Podfile.lock') }}-${{ hashFiles('ios/Runner.xcodeproj/**') }}
          restore-keys: |
            ${{ runner.os }}-xcode-build-${{ hashFiles('ios/Podfile.lock') }}-
            ${{ runner.os }}-xcode-build-

      - name: Clean Flutter build artifacts
        if: steps.cocoapods-cache.outputs.cache-hit != 'true'
        run: |
          echo "üßπ Cleaning Flutter build artifacts (cache miss)..."
          flutter clean
          rm -rf build/ios

      - name: Enable Keychain Sharing for GIDSignIn
        run: |
          ENTITLEMENTS_FILE="ios/Runner/Runner.entitlements"

          if [ ! -f "$ENTITLEMENTS_FILE" ]; then
            echo "üìù Creating entitlements file..."
            printf '<?xml version="1.0" encoding="UTF-8"?>\n' > "$ENTITLEMENTS_FILE"
            printf '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n' >> "$ENTITLEMENTS_FILE"
            printf '<plist version="1.0">\n' >> "$ENTITLEMENTS_FILE"
            printf '<dict>\n' >> "$ENTITLEMENTS_FILE"
            printf '\t<key>keychain-access-groups</key>\n' >> "$ENTITLEMENTS_FILE"
            printf '\t<array>\n' >> "$ENTITLEMENTS_FILE"
            printf '\t\t<string>$(AppIdentifierPrefix)com.bodyaiface.sergeyai</string>\n' >> "$ENTITLEMENTS_FILE"
            printf '\t\t<string>$(AppIdentifierPrefix)com.google.GIDSignIn</string>\n' >> "$ENTITLEMENTS_FILE"
            printf '\t</array>\n' >> "$ENTITLEMENTS_FILE"
            printf '</dict>\n' >> "$ENTITLEMENTS_FILE"
            printf '</plist>\n' >> "$ENTITLEMENTS_FILE"
            echo "‚úÖ Entitlements file created with GIDSignIn keychain group"
          else
            echo "‚úÖ Entitlements file found"
            
            if ! grep -q "com.google.GIDSignIn" "$ENTITLEMENTS_FILE"; then
              echo "üìù Adding GIDSignIn keychain group..."
              if command -v /usr/libexec/PlistBuddy &> /dev/null; then
                GROUP_COUNT=$(/usr/libexec/PlistBuddy -c "Print :keychain-access-groups" "$ENTITLEMENTS_FILE" 2>/dev/null | grep -c "string" || echo "0")
                /usr/libexec/PlistBuddy -c "Add :keychain-access-groups:$GROUP_COUNT string \$(AppIdentifierPrefix)com.google.GIDSignIn" "$ENTITLEMENTS_FILE" 2>/dev/null && echo "‚úÖ GIDSignIn keychain group added" || echo "‚ö†Ô∏è  Failed to add via PlistBuddy"
              fi
              
              if ! grep -q "com.google.GIDSignIn" "$ENTITLEMENTS_FILE"; then
                echo "üìù Using alternative method..."
                TEMP_FILE=$(mktemp)
                sed 's|</array>|\t\t<string>$(AppIdentifierPrefix)com.google.GIDSignIn</string>\n\t</array>|' "$ENTITLEMENTS_FILE" > "$TEMP_FILE"
                mv "$TEMP_FILE" "$ENTITLEMENTS_FILE"
                echo "‚úÖ GIDSignIn keychain group added"
              fi
            else
              echo "‚úÖ GIDSignIn keychain group already exists"
            fi
          fi

          echo "üìã Verifying entitlements content:"
          cat "$ENTITLEMENTS_FILE"

      - name: Setup Google Sign-In for iOS
        run: |
          if [ -f scripts/setup_ios_google_signin.sh ]; then
            echo "üìù Running setup script for Google Sign-In..."
            bash scripts/setup_ios_google_signin.sh
          else
            echo "üìù Setting up Google Sign-In manually..."
            if [ -f ios/Runner/GoogleService-Info.plist ]; then
              echo "üìù Extracting REVERSED_CLIENT_ID from GoogleService-Info.plist..."
              REVERSED_CLIENT_ID=$(/usr/libexec/PlistBuddy -c "Print :REVERSED_CLIENT_ID" ios/Runner/GoogleService-Info.plist 2>/dev/null || echo "")
              if [ -z "$REVERSED_CLIENT_ID" ]; then
                REVERSED_CLIENT_ID=$(grep -A 1 "REVERSED_CLIENT_ID" ios/Runner/GoogleService-Info.plist | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | sed 's/[[:space:]]*//' | head -1)
              fi
              if [ -n "$REVERSED_CLIENT_ID" ]; then
                echo "‚úÖ REVERSED_CLIENT_ID extracted: $REVERSED_CLIENT_ID"
                echo "üìù Injecting REVERSED_CLIENT_ID into Info.plist..."
                if [[ "$OSTYPE" == "darwin"* ]]; then
                  sed -i '' "s|GOOGLE_REVERSED_CLIENT_ID_PLACEHOLDER|$REVERSED_CLIENT_ID|g" ios/Runner/Info.plist
                else
                  sed -i "s|GOOGLE_REVERSED_CLIENT_ID_PLACEHOLDER|$REVERSED_CLIENT_ID|g" ios/Runner/Info.plist
                fi
                echo "‚úÖ REVERSED_CLIENT_ID injected into Info.plist"
              else
                echo "‚ö†Ô∏è  Warning: Could not extract REVERSED_CLIENT_ID from GoogleService-Info.plist"
                echo "‚ö†Ô∏è  Google Sign-In may not work correctly"
              fi
            else
              echo "‚ö†Ô∏è  Warning: GoogleService-Info.plist not found"
              echo "‚ö†Ô∏è  Google Sign-In URL scheme will not be configured"
            fi
          fi

          echo "üìã Verifying Info.plist has correct URL scheme..."
          if grep -q "GOOGLE_REVERSED_CLIENT_ID_PLACEHOLDER" ios/Runner/Info.plist; then
            echo "‚ùå ERROR: Placeholder still exists in Info.plist!"
            echo "üìã Info.plist CFBundleURLSchemes:"
            grep -A 2 "CFBundleURLSchemes" ios/Runner/Info.plist
            exit 1
          else
            echo "‚úÖ Info.plist URL scheme configured correctly"
            echo "üìã Info.plist CFBundleURLSchemes:"
            grep -A 2 "CFBundleURLSchemes" ios/Runner/Info.plist
          fi

      - name: Generate Flutter xcconfig files
        env:
          ADMOB_APP_ID: ${{ secrets.ADMOB_APP_ID }}
        run: |
          echo "üìù Generating Flutter xcconfig files..."
          mkdir -p ios/Flutter/ephemeral

          echo "üì¶ Running flutter pub get to ensure hooks_runner is generated..."
          flutter pub get

          cd ios
          flutter precache --ios
          cd ..

          echo "üìù Creating Debug.xcconfig in ios/Flutter..."
          mkdir -p ios/Flutter
          printf '#include "Generated.xcconfig"\n' > ios/Flutter/Debug.xcconfig
          if [ -n "$ADMOB_APP_ID" ]; then
            echo "ADMOB_APP_ID=$ADMOB_APP_ID" >> ios/Flutter/Debug.xcconfig
            echo "‚úÖ Added ADMOB_APP_ID to Debug.xcconfig"
          fi

          echo "üìù Creating Release.xcconfig in ios/Flutter..."
          printf '#include "Generated.xcconfig"\n' > ios/Flutter/Release.xcconfig
          if [ -n "$ADMOB_APP_ID" ]; then
            echo "ADMOB_APP_ID=$ADMOB_APP_ID" >> ios/Flutter/Release.xcconfig
            echo "‚úÖ Added ADMOB_APP_ID to Release.xcconfig"
          fi

          echo "‚úÖ Flutter xcconfig files created"
          echo "üìã Verifying files in ios/Flutter:"
          ls -lh ios/Flutter/*.xcconfig 2>/dev/null || echo "‚ö†Ô∏è  No xcconfig files found"
          if [ -f ios/Flutter/Debug.xcconfig ]; then
            echo "‚úÖ Debug.xcconfig exists in ios/Flutter"
            echo "üìÑ Debug.xcconfig contents:"
            cat ios/Flutter/Debug.xcconfig
          else
            echo "‚ùå Debug.xcconfig NOT found in ios/Flutter"
          fi

      - name: Build iOS for simulator
        env:
          ADMOB_APP_ID: ${{ secrets.ADMOB_APP_ID }}
        run: |
          FLUTTER_CACHE_HIT="${{ steps.flutter-build-cache.outputs.cache-hit }}"
          XCODE_CACHE_HIT="${{ steps.xcode-build-cache.outputs.cache-hit }}"

          if [ "$FLUTTER_CACHE_HIT" == "true" ] && [ "$XCODE_CACHE_HIT" == "true" ]; then
            echo "‚úÖ Using cached iOS build artifacts - full incremental build"
            echo "üì¶ Both Flutter and Xcode caches restored"
            echo "‚è±Ô∏è Expected build time: 2-5 minutes (incremental)"
          elif [ "$FLUTTER_CACHE_HIT" == "true" ] || [ "$XCODE_CACHE_HIT" == "true" ]; then
            echo "‚ö†Ô∏è Partial cache hit - some artifacts will be rebuilt"
            echo "‚è±Ô∏è Expected build time: 10-15 minutes (partial cache)"
          else
            echo "üì¶ Building iOS from scratch (cache miss)"
            echo "‚è±Ô∏è This will take ~20-25 minutes on first build"
          fi

          if [ ! -f ios/Flutter/Debug.xcconfig ]; then
            echo "‚ö†Ô∏è  Debug.xcconfig is missing, creating it in ios/Flutter..."
            mkdir -p ios/Flutter
            printf '#include "Generated.xcconfig"\n' > ios/Flutter/Debug.xcconfig
            if [ -n "$ADMOB_APP_ID" ]; then
              echo "ADMOB_APP_ID=$ADMOB_APP_ID" >> ios/Flutter/Debug.xcconfig
            fi
            echo "‚úÖ Created Debug.xcconfig in ios/Flutter"
          fi

          echo "üìã Verifying entitlements before build..."
          if [ -f ios/Runner/Runner.entitlements ]; then
            echo "‚úÖ Runner.entitlements exists"
            echo "üìã Entitlements content:"
            cat ios/Runner/Runner.entitlements
            if ! grep -q "com.google.GIDSignIn" ios/Runner/Runner.entitlements; then
              echo "‚ùå ERROR: com.google.GIDSignIn not found in entitlements!"
              exit 1
            fi
          else
            echo "‚ùå ERROR: Runner.entitlements not found!"
            exit 1
          fi

          echo "üìã Verifying CODE_SIGN_ENTITLEMENTS in project.pbxproj..."
          if grep -q "CODE_SIGN_ENTITLEMENTS = Runner/Runner.entitlements" ios/Runner.xcodeproj/project.pbxproj; then
            echo "‚úÖ CODE_SIGN_ENTITLEMENTS is set correctly"
          else
            echo "‚ùå ERROR: CODE_SIGN_ENTITLEMENTS not found in project.pbxproj!"
            exit 1
          fi

          echo "üìù Building iOS with code signing (required for keychain entitlements)..."
          flutter build ios --debug --simulator

          echo "üìã Verifying entitlements after build..."
          APP_PATH=$(find build/ios -name "Runner.app" -type d 2>/dev/null | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "‚úÖ Found Runner.app at: $APP_PATH"
            
            echo "üìã Checking app bundle structure..."
            ls -la "$APP_PATH" | head -10
            
            if [ -f "$APP_PATH/embedded.mobileprovision" ]; then
              echo "‚úÖ Found embedded.mobileprovision"
            else
              echo "‚ö†Ô∏è  No embedded.mobileprovision (may be normal for simulator build)"
            fi
            
            echo "üìã Checking for entitlements in app bundle..."
            if [ -f "$APP_PATH/archived-expanded-entitlements.xcent" ]; then
              echo "‚úÖ Found archived-expanded-entitlements.xcent"
              echo "üìã Entitlements from app bundle:"
              cat "$APP_PATH/archived-expanded-entitlements.xcent" 2>/dev/null || echo "‚ö†Ô∏è  Could not read entitlements file"
              if grep -q "com.google.GIDSignIn" "$APP_PATH/archived-expanded-entitlements.xcent" 2>/dev/null; then
                echo "‚úÖ GIDSignIn found in app bundle entitlements!"
              else
                echo "‚ö†Ô∏è  GIDSignIn not found in app bundle entitlements"
              fi
            else
              echo "‚ö†Ô∏è  archived-expanded-entitlements.xcent not found"
              echo "üìã Trying to extract entitlements using codesign..."
              if command -v codesign &> /dev/null; then
                codesign -d --entitlements - "$APP_PATH" 2>/dev/null | grep -q "com.google.GIDSignIn" && echo "‚úÖ GIDSignIn found via codesign" || echo "‚ö†Ô∏è  GIDSignIn not found via codesign"
              fi
            fi
            
            echo "üìã Verifying Info.plist in app bundle..."
            if [ -f "$APP_PATH/Info.plist" ]; then
              echo "‚úÖ Found Info.plist in app bundle"
              echo "üìã Checking CFBundleURLSchemes in app bundle Info.plist:"
              if command -v plutil &> /dev/null; then
                plutil -p "$APP_PATH/Info.plist" | grep -A 5 "CFBundleURLSchemes" || echo "‚ö†Ô∏è  CFBundleURLSchemes not found"
              elif command -v /usr/libexec/PlistBuddy &> /dev/null; then
                /usr/libexec/PlistBuddy -c "Print :CFBundleURLTypes" "$APP_PATH/Info.plist" 2>/dev/null || echo "‚ö†Ô∏è  CFBundleURLTypes not found"
              else
                grep -A 5 "CFBundleURLSchemes" "$APP_PATH/Info.plist" || echo "‚ö†Ô∏è  CFBundleURLSchemes not found"
              fi
            else
              echo "‚ö†Ô∏è  Info.plist not found in app bundle"
            fi
            
            echo "üìã Summary for Appetize.io:"
            echo "  - App bundle: $APP_PATH"
            echo "  - Entitlements file exists: $([ -f ios/Runner/Runner.entitlements ] && echo 'YES' || echo 'NO')"
            echo "  - GIDSignIn in entitlements: $(grep -q 'com.google.GIDSignIn' ios/Runner/Runner.entitlements && echo 'YES' || echo 'NO')"
            echo "  - REVERSED_CLIENT_ID in Info.plist: $(grep -q 'GOOGLE_REVERSED_CLIENT_ID_PLACEHOLDER' ios/Runner/Info.plist && echo 'NO (placeholder)' || echo 'YES (injected)')"
          else
            echo "‚ö†Ô∏è  Runner.app not found immediately after build"
          fi

      - name: Copy GoogleService-Info.plist to app bundle
        working-directory: ${{ github.workspace }}
        run: |
          echo "üîç Searching for Runner.app..."
          APP_PATH=$(find build/ios -name "Runner.app" -type d 2>/dev/null | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ö†Ô∏è Runner.app not found in build/ios, searching in all directories..."
            APP_PATH=$(find . -name "Runner.app" -type d -not -path "*/.*" 2>/dev/null | head -1)
          fi

          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Runner.app not found, cannot copy GoogleService-Info.plist"
            exit 1
          fi

          echo "‚úÖ Found Runner.app at: $APP_PATH"

          if [ -f ios/Runner/GoogleService-Info.plist ]; then
            echo "üìã Copying GoogleService-Info.plist to app bundle..."
            cp ios/Runner/GoogleService-Info.plist "$APP_PATH/GoogleService-Info.plist"
            
            if [ -f "$APP_PATH/GoogleService-Info.plist" ]; then
              echo "‚úÖ GoogleService-Info.plist copied successfully to app bundle"
              ls -lh "$APP_PATH/GoogleService-Info.plist"
              echo "üìã Verifying file content..."
              head -5 "$APP_PATH/GoogleService-Info.plist" | grep -q "<?xml" && echo "‚úÖ File is valid XML" || echo "‚ö†Ô∏è  File may be corrupted"
            else
              echo "‚ùå Failed to copy GoogleService-Info.plist to app bundle"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  Warning: GoogleService-Info.plist not found in ios/Runner/"
            echo "‚ö†Ô∏è  Firebase features may not work without this file"
          fi

      - name: Find and package .app bundle
        working-directory: ${{ github.workspace }}
        run: |
          echo "üîç Searching for Runner.app..."
          APP_PATH=$(find build/ios -name "Runner.app" -type d 2>/dev/null | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ö†Ô∏è Runner.app not found in build/ios, searching in all directories..."
            APP_PATH=$(find . -name "Runner.app" -type d -not -path "*/.*" 2>/dev/null | head -1)
          fi

          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Runner.app not found anywhere"
            echo "üìã Available .app files:"
            find . -name "*.app" -type d 2>/dev/null | head -10
            exit 1
          fi

          echo "‚úÖ Found Runner.app at: $APP_PATH"
          echo "üì¶ Creating ZIP archive..."
          cd "$(dirname "$APP_PATH")"
          zip -r "$GITHUB_WORKSPACE/Runner.app.zip" Runner.app
          cd "$GITHUB_WORKSPACE"

          if [ -f Runner.app.zip ]; then
            ZIP_SIZE=$(ls -lh Runner.app.zip | awk '{print $5}')
            echo "‚úÖ Runner.app.zip created successfully: $ZIP_SIZE"
            ls -lh Runner.app.zip
          else
            echo "‚ùå Failed to create Runner.app.zip"
            exit 1
          fi

      - name: Inject ADMOB_APP_ID into iOS Release.xcconfig
        env:
          ADMOB_APP_ID: ${{ secrets.ADMOB_APP_ID }}
        if: env.ADMOB_APP_ID
        run: |
          echo "üìù Configuring iOS Release.xcconfig with ADMOB_APP_ID..."
          XCCONFIG_FILE=ios/Flutter/Release.xcconfig
          if [ ! -f "$XCCONFIG_FILE" ]; then
            echo "Creating $XCCONFIG_FILE..."
            touch "$XCCONFIG_FILE"
          fi
          if grep -q "^ADMobApplicationID" "$XCCONFIG_FILE"; then
            sed -i '' "s|^ADMobApplicationID =.*|ADMobApplicationID = ${{ secrets.ADMOB_APP_ID }}|" "$XCCONFIG_FILE"
          else
            echo "ADMobApplicationID = ${{ secrets.ADMOB_APP_ID }}" >> "$XCCONFIG_FILE"
          fi
          echo "‚úÖ ADMOB_APP_ID injected into iOS xcconfig"

      - name: Upload iOS app artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-bundle
          path: ${{ github.workspace }}/Runner.app.zip
          retention-days: 7
          if-no-files-found: error

      - name: Build summary
        if: always()
        run: |
          echo "## iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f Runner.app.zip ]; then
            echo "- ‚úÖ Flutter dependencies installed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ CocoaPods installed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ iOS app built for simulator" >> $GITHUB_STEP_SUMMARY
            echo "- üì¶ Artifact: Runner.app.zip" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Cache Status:" >> $GITHUB_STEP_SUMMARY
            echo "- Flutter pub cache: ${{ steps.flutter-pub-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
            echo "- CocoaPods cache: ${{ steps.cocoapods-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
            echo "- Flutter build cache: ${{ steps.flutter-build-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
            echo "- Xcode build cache: ${{ steps.xcode-build-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Download the artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
            echo "2. Extract Runner.app.zip" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è Build may have failed or was cancelled" >> $GITHUB_STEP_SUMMARY
            echo "- Check logs above for details" >> $GITHUB_STEP_SUMMARY
          fi
